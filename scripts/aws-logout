#!/bin/bash
#
# aws-logout - AWS SSOからログアウトするためのスクリプト
#
# 使用方法:
#   aws-logout [profile-name]  : 特定のプロファイルからログアウト
#   aws-logout --all           : すべてのプロファイルからログアウト
#

set -e

# --all 引数をチェック
# すべてのプロファイルからログアウトする場合
if [ "$1" = "--all" ]; then
    echo "Logging out from all profiles..."

    # .envファイルから既存のAWS関連設定を削除
    # AWS環境変数をクリーンアップ
    sed -i '/AWS/d' ${USER_DIR}/.env

    # AWS CLI: すべてのプロファイルからログアウト
    aws logout --all || true

    # .aws/configファイルのパスを取得（環境変数またはデフォルト）
    CONFIG_FILE="${AWS_CONFIG_FILE:-$HOME/.aws/config}"

    # .aws/configから-signinサフィックスを持つすべてのプロファイルセクションを削除
    if [ -f "$CONFIG_FILE" ]; then
        # awkを使用して-signinで終わる[profile ...]セクションを削除
        awk '
        /^\[profile .*-signin\]/ {
            # -signinで終わるprofileセクションの開始を検出
            in_signin_profile = 1
            next
        }
        /^\[/ {
            # 他のセクションに入ったら-signinプロファイルセクションを抜ける
            in_signin_profile = 0
        }
        {
            # -signinプロファイルセクション内の行はスキップ
            if (in_signin_profile) {
                next
            }
            # それ以外の行は出力
            print
        }
        ' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
        echo "Removed all -signin profile sections from config"
    fi

    echo "Logout from all profiles completed"

# 特定のプロファイルからログアウトする場合
else
    # 引数で指定されたプロファイル名、または環境変数AWS_PROFILEを使用
    echo "Current profile is \"${1:-$AWS_PROFILE}\"."

    # .envファイルから既存のAWS関連設定を削除
    # AWS環境変数をクリーンアップ
    sed -i '/AWS/d' ${USER_DIR}/.env

    # プロファイル名に"-signin"サフィックスを付与
    # AWS CLI v2のログアウトではサインインプロファイルを使用する必要がある
    # 例: "my-profile" → "my-profile-signin"
    export AWS_PROFILE="${1:-$AWS_PROFILE}-signin"

    # AWS CLI: 指定したプロファイルからログアウト
    aws logout || true

    # .aws/configファイルのパスを取得（環境変数またはデフォルト）
    CONFIG_FILE="${AWS_CONFIG_FILE:-$HOME/.aws/config}"

    # .aws/configから特定プロファイルのセクション全体を削除
    if [ -f "$CONFIG_FILE" ]; then
        # awkを使用して以下の処理を実行:
        # 1. [profile PROFILE_NAME]セクションを検出
        # 2. そのセクション全体を削除
        # 3. 他のセクションや設定は保持
        awk -v profile="$AWS_PROFILE" '
        /^\[profile / {
            # プロファイルセクションの開始を検出
            in_target_section = 0
            if ($0 == "[profile " profile "]") {
                # 対象プロファイルのセクションに入る
                in_target_section = 1
                next
            }
        }
        /^\[/ {
            # 他のセクションに入ったら対象セクションを抜ける
            in_target_section = 0
        }
        {
            # 対象セクション内の行はすべてスキップ
            if (in_target_section) {
                next
            }
            # それ以外の行は出力
            print
        }
        ' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
        echo "Removed profile section '$AWS_PROFILE'"
    fi

    echo "Logout completed"
fi
